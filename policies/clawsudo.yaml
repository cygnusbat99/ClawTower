# ClawAV clawsudo Enforcement Policies
#
# These policies are enforced by clawsudo (the sudo proxy).
# Unlike default.yaml (detection-only), these BLOCK commands.
#
# enforcement: allow  → permit the command
# enforcement: deny   → block the command
# (no enforcement)    → detect only, don't block
#
# ORDER MATTERS: first match wins. Deny rules MUST come before allow rules
# to prevent broad allow patterns from overriding specific deny patterns.

rules:
  # ── Denied Commands (checked FIRST) ────────────────────────────────────────
  - name: "deny-clawav-tamper"
    description: "Block modifications to ClawAV config and binaries"
    match:
      command_contains:
        - "/etc/clawav"
        - "/usr/local/bin/clawav"
        - "/usr/local/bin/clawsudo"
        - "chattr"
        - "auditctl -D"
        - "auditctl -e 0"
        - "apparmor_parser -R"
    action: critical
    enforcement: deny

  - name: "deny-firewall-disable"
    match:
      command_contains:
        - "ufw disable"
        - "iptables -F"
        - "iptables --flush"
        - "nft flush"
    action: critical
    enforcement: deny

  - name: "deny-dangerous-rm"
    match:
      command_contains:
        - "rm -rf /etc"
        - "rm -rf /usr"
        - "rm -rf /var"
        - "rm -rf /home"
        - "rm -rf /boot"
        - "rm -rf /"
    action: critical
    enforcement: deny

  - name: "deny-reverse-shell"
    description: "Block reverse shell patterns via sudo"
    match:
      command_contains:
        - "/dev/tcp/"
        - "/dev/udp/"
        - "bash -i"
        - "sh -i"
        - "nc -e"
    action: critical
    enforcement: deny

  # Catch-all: deny raw shell via sudo
  # Agents shouldn't need `sudo bash` — specific commands should be allowlisted above.
  - name: "deny-sudo-shell"
    description: "Block sudo to raw shell (use specific commands instead)"
    match:
      command: ["bash", "sh", "zsh", "dash"]
    action: critical
    enforcement: deny

  # ── Allowed Commands (checked AFTER denies) ────────────────────────────────
  - name: "allow-apt"
    match:
      command: ["apt", "apt-get", "dpkg"]
    action: info
    enforcement: allow

  - name: "allow-docker"
    match:
      command: ["docker", "docker-compose"]
    action: info
    enforcement: allow

  - name: "allow-systemctl"
    description: "Allow service management"
    match:
      command: ["systemctl"]
    action: info
    enforcement: allow

  - name: "allow-journalctl"
    match:
      command: ["journalctl"]
    action: info
    enforcement: allow

  - name: "allow-ufw"
    match:
      command: ["ufw"]
    action: info
    enforcement: allow

  - name: "allow-file-ops"
    description: "Allow common file operations via sudo"
    match:
      command: ["cp", "mv", "mkdir", "chown", "chmod", "rm", "tee", "sed", "cat"]
    action: info
    enforcement: allow

  - name: "allow-ip"
    match:
      command: ["ip"]
    action: info
    enforcement: allow
