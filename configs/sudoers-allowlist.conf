# ClawAV Sudoers Policy for AI Agent
# Replaces both /etc/sudoers.d/010_pi-nopasswd AND /etc/sudoers.d/clawav-deny
#
# IMPORTANT: sudoers uses LAST MATCH WINS
# So: allow rules first, deny rules last (denies override allows)
#
# Install:
#   sudo visudo -cf /path/to/this/file   # validate first!
#   sudo cp this /etc/sudoers.d/010_pi-nopasswd
#   sudo chmod 440 /etc/sudoers.d/010_pi-nopasswd
#   sudo rm /etc/sudoers.d/clawav-deny   # consolidated into this file
#   sudo chattr +i /etc/sudoers.d/010_pi-nopasswd

# ===========================================================================
# ALLOW RULES (base grants)
# ===========================================================================

# Read-only tools
openclaw ALL=(ALL) NOPASSWD: /usr/bin/cat, /usr/bin/ls, /usr/bin/head, \
    /usr/bin/tail, /usr/bin/grep, /usr/bin/find, /usr/bin/stat, \
    /usr/bin/wc, /usr/bin/diff, /usr/bin/file, /usr/bin/readlink, \
    /usr/bin/getent, /usr/bin/id, /usr/bin/whoami, /usr/bin/test, \
    /usr/bin/sort, /usr/bin/uniq, /usr/bin/tr, /usr/bin/cut, \
    /usr/bin/md5sum, /usr/bin/sha256sum, /usr/bin/strings

# Log & diagnostics
openclaw ALL=(ALL) NOPASSWD: /usr/bin/journalctl, /usr/bin/dmesg, \
    /usr/bin/ss, /usr/bin/lsof, /usr/sbin/lsof, \
    /usr/bin/df, /usr/bin/du, /usr/bin/mount, \
    /usr/bin/free, /usr/bin/uptime, /usr/bin/top, /usr/bin/ps, \
    /usr/bin/ip, /usr/sbin/ip, /usr/bin/netstat, /usr/sbin/netstat

# Service management
openclaw ALL=(ALL) NOPASSWD: /usr/bin/systemctl status *, \
    /usr/bin/systemctl is-active *, \
    /usr/bin/systemctl show *, \
    /usr/bin/systemctl list-units *, \
    /usr/bin/systemctl start *, \
    /usr/bin/systemctl restart *, \
    /usr/bin/systemctl enable *, \
    /usr/bin/systemctl daemon-reload, \
    /usr/bin/systemd-run *

# Package management
openclaw ALL=(ALL) NOPASSWD: /usr/bin/apt, /usr/bin/apt-get, \
    /usr/bin/dpkg, /usr/bin/apt-cache

# Write tools (restricted by deny rules below)
openclaw ALL=(ALL) NOPASSWD: /usr/bin/tee, /usr/bin/tee -a *, \
    /usr/bin/cp, /usr/bin/mv, /usr/bin/ln, \
    /usr/bin/mkdir, /usr/bin/chmod, /usr/bin/chown, \
    /usr/bin/rm, /usr/bin/rmdir, /usr/bin/touch, /usr/bin/install

# Text processing (non-destructive use)
openclaw ALL=(ALL) NOPASSWD: /usr/bin/sed, /usr/bin/awk, \
    /usr/bin/curl, /usr/bin/wget

# ===========================================================================
# DENY RULES (last match wins â€” these override the allows above)
# ===========================================================================

# --- Shells & interpreters (root shell equivalent) ---
openclaw ALL=(ALL) !/usr/bin/bash, !/usr/bin/sh, !/usr/bin/dash, \
    !/usr/bin/zsh, !/usr/bin/fish, \
    !/usr/bin/python3, !/usr/bin/python3 *, \
    !/usr/bin/python, !/usr/bin/python *, \
    !/usr/bin/perl, !/usr/bin/perl *, \
    !/usr/bin/ruby, !/usr/bin/ruby *, \
    !/usr/bin/node, !/usr/bin/node *, \
    !/usr/local/bin/node, !/usr/local/bin/node *, \
    !/usr/bin/env bash, !/usr/bin/env sh, \
    !/usr/bin/env python3, !/usr/bin/env perl, \
    !/usr/bin/env node

# --- su / sudo escalation ---
openclaw ALL=(ALL) !/usr/bin/su, !/usr/bin/su *, \
    !/usr/sbin/su, !/usr/sbin/su *

# --- User/password management ---
openclaw ALL=(ALL) !/usr/bin/passwd, !/usr/bin/passwd *, \
    !/usr/bin/chpasswd, \
    !/usr/sbin/useradd, !/usr/sbin/usermod, !/usr/sbin/usermod *, \
    !/usr/sbin/userdel, !/usr/sbin/groupmod, \
    !/usr/sbin/deluser, !/usr/sbin/adduser, \
    !/usr/bin/chage, !/usr/bin/gpasswd, \
    !/usr/bin/chsh, !/usr/bin/chfn

# --- Sudoers editing ---
openclaw ALL=(ALL) !/usr/sbin/visudo, !/usr/bin/sudoedit

# --- Process killing ---
openclaw ALL=(ALL) !/usr/bin/kill, !/usr/bin/kill *, \
    !/usr/bin/killall, !/usr/bin/killall *, \
    !/usr/bin/pkill, !/usr/bin/pkill *

# --- systemctl destructive ops ---
openclaw ALL=(ALL) !/usr/bin/systemctl stop *, \
    !/usr/bin/systemctl disable *, \
    !/usr/bin/systemctl mask *

# --- chattr (prevent immutability manipulation) ---
openclaw ALL=(ALL) !/usr/bin/chattr, !/usr/bin/chattr *

# --- In-place file editing (can target any file) ---
openclaw ALL=(ALL) !/usr/bin/sed -i *, !/usr/bin/sed --in-place *

# --- dd (raw block write) ---
openclaw ALL=(ALL) !/usr/bin/dd, !/usr/bin/dd *

# --- Write tools targeting auth/security files ---
# /etc/shadow, /etc/passwd, /etc/group, /etc/gshadow
openclaw ALL=(ALL) !/usr/bin/tee /etc/shadow, !/usr/bin/tee -a /etc/shadow, \
    !/usr/bin/tee /etc/passwd, !/usr/bin/tee -a /etc/passwd, \
    !/usr/bin/tee /etc/group, !/usr/bin/tee -a /etc/group, \
    !/usr/bin/tee /etc/gshadow, !/usr/bin/tee -a /etc/gshadow, \
    !/usr/bin/cp * /etc/shadow, !/usr/bin/cp * /etc/passwd, \
    !/usr/bin/cp * /etc/group, !/usr/bin/cp * /etc/gshadow, \
    !/usr/bin/mv * /etc/shadow, !/usr/bin/mv * /etc/passwd, \
    !/usr/bin/mv * /etc/group, !/usr/bin/mv * /etc/gshadow, \
    !/usr/bin/chmod * /etc/shadow, !/usr/bin/chmod * /etc/passwd, \
    !/usr/bin/chown * /etc/shadow, !/usr/bin/chown * /etc/passwd, \
    !/usr/bin/rm /etc/shadow, !/usr/bin/rm /etc/passwd

# /etc/sudoers and /etc/sudoers.d/
openclaw ALL=(ALL) !/usr/bin/tee /etc/sudoers, !/usr/bin/tee -a /etc/sudoers, \
    !/usr/bin/tee /etc/sudoers.d/*, !/usr/bin/tee -a /etc/sudoers.d/*, \
    !/usr/bin/cp * /etc/sudoers, !/usr/bin/cp * /etc/sudoers.d/*, \
    !/usr/bin/mv * /etc/sudoers, !/usr/bin/mv * /etc/sudoers.d/*, \
    !/usr/bin/chmod * /etc/sudoers, !/usr/bin/chmod * /etc/sudoers.d/*, \
    !/usr/bin/chown * /etc/sudoers, !/usr/bin/chown * /etc/sudoers.d/*, \
    !/usr/bin/rm /etc/sudoers, !/usr/bin/rm /etc/sudoers.d/*, \
    !/usr/bin/rm -f /etc/sudoers.d/*, !/usr/bin/rm -rf /etc/sudoers.d

# /etc/ssh/ and /root/.ssh/
openclaw ALL=(ALL) !/usr/bin/tee /etc/ssh/*, !/usr/bin/tee -a /etc/ssh/*, \
    !/usr/bin/cp * /etc/ssh/*, !/usr/bin/mv * /etc/ssh/*, \
    !/usr/bin/tee /root/.ssh/*, !/usr/bin/tee -a /root/.ssh/*, \
    !/usr/bin/cp * /root/.ssh/*, !/usr/bin/mkdir /root/.ssh, \
    !/usr/bin/chmod * /etc/ssh/*, !/usr/bin/chown * /etc/ssh/*

# /etc/pam.d/ (auth bypass)
openclaw ALL=(ALL) !/usr/bin/tee /etc/pam.d/*, !/usr/bin/tee -a /etc/pam.d/*, \
    !/usr/bin/cp * /etc/pam.d/*, !/usr/bin/mv * /etc/pam.d/*, \
    !/usr/bin/rm /etc/pam.d/*, !/usr/bin/rm -f /etc/pam.d/*

# ClawAV binary, config, and service
openclaw ALL=(ALL) !/usr/bin/tee /usr/local/bin/clawav, \
    !/usr/bin/tee /etc/clawav/*, !/usr/bin/tee -a /etc/clawav/*, \
    !/usr/bin/cp * /usr/local/bin/clawav, !/usr/bin/cp * /etc/clawav/*, \
    !/usr/bin/mv * /usr/local/bin/clawav, !/usr/bin/mv * /etc/clawav/*, \
    !/usr/bin/chmod * /usr/local/bin/clawav, !/usr/bin/chmod * /etc/clawav/*, \
    !/usr/bin/chown * /usr/local/bin/clawav, !/usr/bin/chown * /etc/clawav/*, \
    !/usr/bin/rm /usr/local/bin/clawav, !/usr/bin/rm -f /usr/local/bin/clawav, \
    !/usr/bin/rm -rf /etc/clawav, !/usr/bin/rm -rf /etc/clawav/*, \
    !/usr/bin/tee /etc/systemd/system/clawav.service, \
    !/usr/bin/cp * /etc/systemd/system/clawav.service, \
    !/usr/bin/mv * /etc/systemd/system/clawav.service, \
    !/usr/bin/rm /etc/systemd/system/clawav.service

# /etc/ld.so.preload and /etc/ld.so.conf (library injection)
openclaw ALL=(ALL) !/usr/bin/tee /etc/ld.so.preload, !/usr/bin/tee -a /etc/ld.so.preload, \
    !/usr/bin/cp * /etc/ld.so.preload, \
    !/usr/bin/tee /etc/ld.so.conf, !/usr/bin/tee -a /etc/ld.so.conf, \
    !/usr/bin/cp * /etc/ld.so.conf

# /etc/cron.d/ and root crontab (persistence)
openclaw ALL=(ALL) !/usr/bin/tee /etc/cron.d/*, !/usr/bin/tee -a /etc/cron.d/*, \
    !/usr/bin/cp * /etc/cron.d/*, \
    !/usr/bin/tee /var/spool/cron/crontabs/root, \
    !/usr/bin/tee -a /var/spool/cron/crontabs/root, \
    !/usr/bin/rm /etc/cron.d/*, !/usr/bin/rm -f /etc/cron.d/*
